name: Claude Code Review

# Automated PR code reviews using Claude AI
#
# This workflow provides:
# - Formal GitHub reviews (APPROVE/REQUEST_CHANGES/COMMENT)
# - Inline comments on specific lines of code
# - Auto-resolution of fixed issues on subsequent reviews
# - Patch-ID based caching to skip rebases (no duplicate reviews)
# - Iterative review tracking of previous comments
#
# The review uses the default prompt from this repository's
# .github/prompts/default-pr-review.md

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]

# Ensure only one review runs at a time per PR
# New reviews wait for the current one to complete before starting
concurrency:
  group: claude-review-${{ github.event.pull_request.number }}
  cancel-in-progress: false

jobs:
  claude-review:
    # Skip merge queue PRs, draft PRs (unless authored by claude[bot]), and release promotion PRs
    # DEV-131 requirement #6: Skip workflow for production promotion PRs
    # Exception: Always run on PRs authored by claude[bot] (autonomous task PRs)
    if: |
      !contains(github.head_ref, 'gh-readonly-queue/') &&
      !startsWith(github.head_ref, 'release/next-to-main-') &&
      (
        github.event.pull_request.draft == false ||
        github.event.action == 'ready_for_review' ||
        github.event.pull_request.user.login == 'claude[bot]'
      )

    uses: ./.github/workflows/_claude-code-review.yml
    with:
      pr_number: ${{ github.event.pull_request.number }}
      base_ref: ${{ github.base_ref }}

      # Use Opus 4.5 for comprehensive reviews with reliable inline comments
      # Opus is more capable at following complex multi-step instructions
      # Uncomment one of these to use a different model for reviews:
      # model: 'claude-haiku-4-5'
      # model: 'claude-sonnet-4-5'
      model: 'claude-opus-4-5'

      # Allow standard review conversation turns
      # max_turns: 15

      # Standard timeout for most PRs
      timeout_minutes: 20

      # Optional: Restrict tools for read-only reviews (uncomment to enable)
      # allowed_tools: 'Read,Grep,Glob,Bash(git log),Bash(git diff),Bash(git show)'

    secrets:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

  # Auto-merge Dependabot security updates after successful review
  auto-merge-dependabot:
    needs: claude-review
    if: |
      github.actor == 'dependabot[bot]' &&
      (contains(github.event.pull_request.title, 'security') || contains(github.event.pull_request.title, 'Bump')) &&
      needs.claude-review.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Enable auto-merge for Dependabot updates
        run: gh pr merge --auto --squash "$PR_NUMBER"
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
