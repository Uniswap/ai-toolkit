name: PR Checks

on:
  pull_request:

jobs:
  validate:
    name: Validate Installation & Build
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      NX_BASE: origin/${{ github.base_ref }}

    steps:
      - uses: bullfrogsec/bullfrog@1831f79cce8ad602eef14d2163873f27081ebfb3 # v0.8.4

      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: '22.13.1'
          cache: 'npm'

      - name: Verify package-lock.json
        run: |
          echo "Checking if package-lock.json is up to date..."
          npm install --package-lock-only
          if ! git diff --exit-code package-lock.json; then
            echo "❌ package-lock.json is out of sync!"
            echo "Please run 'npm install' and commit the updated package-lock.json"
            exit 1
          fi
          echo "✅ package-lock.json is up to date"

      - name: Clean install dependencies
        run: |
          echo "Running npm ci to validate clean installation..."
          npm ci
          echo "✅ npm ci completed successfully"

      - name: Build all packages
        run: |
          echo "Building all packages..."
          npx nx affected --target=build
          echo "✅ Build completed successfully"

      - name: Run linting
        run: |
          echo "Running linters..."
          npx nx affected --target=lint
          echo "✅ Linting passed"

      - name: Check formatting
        run: |
          echo "Checking code formatting..."
          npx nx affected --target=format
          echo "✅ Formatting check passed"

      - name: Run tests
        run: |
          echo "Running tests..."
          npx nx affected --target=test run-many --parallel=3 --coverage
          echo "✅ Tests passed"
