name: Notify Release

on:
  workflow_call:
    inputs:
      branch:
        description: 'Branch name that was released'
        required: true
        type: string
      npm_tag:
        description: 'NPM tag used for publishing (next or latest)'
        required: true
        type: string
      before_sha:
        description: 'Commit SHA before the push'
        required: true
        type: string
      after_sha:
        description: 'Commit SHA after the push'
        required: true
        type: string
    secrets:
      ANTHROPIC_API_KEY:
        description: 'Anthropic API key for AI changelog generation'
        required: true
      SLACK_WEBHOOK_URL:
        description: 'Slack webhook URL for notifications'
        required: true

jobs:
  notify:
    runs-on: ubuntu-24.04
    permissions:
      contents: read

    steps:
      - uses: bullfrogsec/bullfrog@1831f79cce8ad602eef14d2163873f27081ebfb3 # v0.8.4

      - name: Checkout repository
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11
        with:
          fetch-depth: 0

      - name: Get package list for Slack notification
        id: package-list
        run: |
          # Get the list of packages that were published
          PACKAGES=$(jq -r '.release.projects[]' nx.json | tr '\n' ', ' | sed 's/,$//')
          echo "packages=$PACKAGES" >> $GITHUB_OUTPUT

      - name: Get git diff for changelog
        id: git-diff
        run: |
          # Get the commit range for this push
          BEFORE_SHA="${{ inputs.before_sha }}"
          AFTER_SHA="${{ inputs.after_sha }}"

          echo "Comparing commits: $BEFORE_SHA...$AFTER_SHA"

          # Get the diff with file changes and commit messages
          DIFF_OUTPUT=$(git diff --stat "$BEFORE_SHA...$AFTER_SHA")
          COMMIT_MESSAGES=$(git log --pretty=format:"- %s (%h)" "$BEFORE_SHA..$AFTER_SHA")

          # Combine into a single output for the AI
          FULL_CONTEXT="## Commits in this push:
          $COMMIT_MESSAGES

          ## Files changed:
          $DIFF_OUTPUT"

          # Save to output using heredoc
          {
            echo 'context<<EOF'
            echo "$FULL_CONTEXT"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

          echo "before_sha=$BEFORE_SHA" >> $GITHUB_OUTPUT
          echo "after_sha=$AFTER_SHA" >> $GITHUB_OUTPUT

      - name: Generate AI-powered changelog
        id: ai-changelog
        continue-on-error: true
        run: |
          # Prepare the prompt for Claude
          PROMPT="You are a changelog generator. Based on the following git changes, create a concise, human-readable changelog summary for Slack.

          Focus on:
          - What features were added
          - What bugs were fixed
          - What was changed or improved

          Format requirements (Slack mrkdwn syntax):
          - Use bullet points (â€¢ or -) for each item, separated by newlines
          - Use *asterisks* for bold (NOT **double asterisks**)
          - Use _underscores_ for italic if needed
          - Keep it to 3-7 items max
          - Be concise and clear
          - Do NOT use # headers
          - Do NOT include commit hashes
          - Do NOT include a 'Changelog' or 'What's Changed' header
          - Just return the bullet points directly

          Example format:
          â€¢ *Added* new feature for user authentication
          â€¢ *Fixed* critical bug in payment processing
          â€¢ *Improved* performance of data loading

          ${{ steps.git-diff.outputs.context }}"

          # Call Anthropic API
          RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: ${{ secrets.ANTHROPIC_API_KEY }}" \
            -H "anthropic-version: 2023-06-01" \
            -d @- <<EOF
          {
            "model": "claude-haiku-4-5",
            "max_tokens": 1024,
            "messages": [{
              "role": "user",
              "content": $(echo "$PROMPT" | jq -Rs .)
            }]
          }
          EOF
          )

          # Extract the changelog from the response
          CHANGELOG=$(echo "$RESPONSE" | jq -r '.content[0].text // empty')

          if [ -z "$CHANGELOG" ]; then
            echo "Error: Failed to generate changelog from API response"
            echo "Response: $RESPONSE"
            exit 1
          fi

          # Save to output
          {
            echo 'changelog<<EOF'
            echo "$CHANGELOG"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: Generate fallback changelog from commits
        if: steps.ai-changelog.outcome == 'failure'
        id: fallback-changelog
        run: |
          # Generate a simple commit list as fallback
          BEFORE_SHA="${{ steps.git-diff.outputs.before_sha }}"
          AFTER_SHA="${{ steps.git-diff.outputs.after_sha }}"

          # Get commits between the two SHAs
          COMMITS=$(git log --pretty=format:"â€¢ %s (%h)" "$BEFORE_SHA..$AFTER_SHA" | head -n 20)

          if [ -z "$COMMITS" ]; then
            COMMITS="â€¢ No commits found in this push"
          fi

          # Save to output
          {
            echo 'changelog<<EOF'
            echo "$COMMITS"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: Determine notification details
        id: notification
        run: |
          if [[ "${{ inputs.branch }}" == "next" ]]; then
            echo "emoji=ðŸ“¦" >> $GITHUB_OUTPUT
            echo "title=Next Branch Packages Published" >> $GITHUB_OUTPUT
            echo "description=Packages from the \`next\` branch have been published to npm with the \`next\` tag." >> $GITHUB_OUTPUT
          else
            echo "emoji=ðŸš€" >> $GITHUB_OUTPUT
            echo "title=Production Packages Published" >> $GITHUB_OUTPUT
            echo "description=Packages from the \`main\` branch have been published to npm with the \`latest\` tag." >> $GITHUB_OUTPUT
          fi

      - name: Send Slack notification
        continue-on-error: true
        uses: slackapi/slack-github-action@91efab103c0de0a537f72a35f6b8cda0ee76bf0a # v2.1.1
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            text: "${{ steps.notification.outputs.emoji }} *${{ steps.notification.outputs.title }}*"
            blocks:
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: "${{ steps.notification.outputs.emoji }} *${{ steps.notification.outputs.title }}*\n\n${{ steps.notification.outputs.description }}"
              - type: "section"
                fields:
                  - type: "mrkdwn"
                    text: "*Branch:*\n`${{ inputs.branch }}`"
                  - type: "mrkdwn"
                    text: "*npm Tag:*\n`${{ inputs.npm_tag }}`"
                  - type: "mrkdwn"
                    text: "*Commits:*\n`${{ steps.git-diff.outputs.before_sha }}` â†’ `${{ steps.git-diff.outputs.after_sha }}`"
                  - type: "mrkdwn"
                    text: "*Packages:*\n${{ steps.package-list.outputs.packages }}"
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: "*What's Changed:*\n${{ steps.ai-changelog.outputs.changelog || steps.fallback-changelog.outputs.changelog || 'No changes detected' }}"
              - type: "actions"
                elements:
                  - type: "button"
                    text:
                      type: "plain_text"
                      text: "View Workflow Run"
                    url: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    style: "primary"
