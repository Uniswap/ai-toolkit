name: Force Publish Packages

# This workflow allows manually force-publishing packages to npm with the 'next' tag.
# It is useful for publishing new packages that haven't had code changes detected,
# or for republishing packages after failed releases.
#
# REQUIRED SECRETS:
# 1. WORKFLOW_PAT: Personal Access Token with 'repo' and 'workflow' scopes
#    - Required to push version commits and tags back to the repository
# 2. NODE_AUTH_TOKEN: NPM authentication token
#    - Required to publish packages to NPM registry
# 3. SERVICE_ACCOUNT_GPG_PRIVATE_KEY: GPG key for signing commits
#    - Required for signed commits and tags
#
# USAGE:
# - Select packages to publish: single package name, comma-separated list, or 'all'
# - Examples:
#   - Single: "@uniswap/ai-toolkit-nx-claude"
#   - Multiple: "@uniswap/ai-toolkit-nx-claude,@ai-toolkit/utils"
#   - All: "all" (publishes all release-configured packages)
#
# BEHAVIOR:
# - Increments the prerelease version (e.g., 0.5.5-next.10 â†’ 0.5.5-next.11)
# - Publishes to npm with the 'next' tag
# - Creates git commits and tags for version bumps
#
# ARCHITECTURE:
# This workflow uses the publish-packages.yml reusable workflow
# to handle the actual publishing logic, avoiding code duplication with
# publish-packages.yml.

on:
  workflow_dispatch:
    inputs:
      packages:
        description: 'Packages to publish (single name, comma-separated list, or "all")'
        required: true
        default: "all"
        type: string
      dryRun:
        description: "Perform a dry run without publishing"
        required: false
        default: "false"
        type: choice
        options:
          - "true"
          - "false"

# Ensure only one force-publish workflow runs at a time
concurrency:
  group: force-publish-${{ github.ref }}
  cancel-in-progress: false

jobs:
  validate:
    name: Validate and resolve packages
    runs-on: ubuntu-24.04
    outputs:
      packages: ${{ steps.resolve-packages.outputs.packages }}
      projects: ${{ steps.resolve-packages.outputs.projects }}
      package_count: ${{ steps.resolve-packages.outputs.package_count }}

    steps:
      - uses: bullfrogsec/bullfrog@1831f79cce8ad602eef14d2163873f27081ebfb3 # v0.8.4

      - name: Validate branch
        env:
          BRANCH_NAME: ${{ github.ref_name }}
        run: |
          if [[ "$BRANCH_NAME" != "next" ]]; then
            echo "âŒ ERROR: Force publish is only allowed on the 'next' branch"
            echo "Current branch: $BRANCH_NAME"
            echo "This workflow publishes with the 'next' npm tag and should only run on the next branch."
            exit 1
          fi
          echo "âœ… Branch validation passed - running on 'next' branch"

      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: ${{ vars.NODE_VERSION }}
          registry-url: "https://registry.npmjs.org"
          scope: "@uniswap"

      - name: Install npm
        run: npm install -g npm@${{ vars.NPM_VERSION }}

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Resolve packages to publish
        id: resolve-packages
        env:
          INPUT_PACKAGES: ${{ github.event.inputs.packages }}
        run: |
          echo "Input packages: \"$INPUT_PACKAGES\""

          # Get all release-configured packages from nx.json
          ALL_PACKAGES=$(npx nx show projects --json 2>/dev/null | jq -r '.[]' | while read project; do
            PROJECT_ROOT=$(npx nx show project "$project" --json 2>/dev/null | jq -r '.root' || echo "")
            if [ -n "$PROJECT_ROOT" ] && [ -f "$PROJECT_ROOT/package.json" ]; then
              IS_PRIVATE=$(jq -r '.private // false' "$PROJECT_ROOT/package.json")
              if [ "$IS_PRIVATE" != "true" ]; then
                PACKAGE_NAME=$(jq -r '.name // ""' "$PROJECT_ROOT/package.json")
                if [ -n "$PACKAGE_NAME" ]; then
                  # Check if this package is in the nx.json release.projects array
                  if jq -e --arg pkg "$PACKAGE_NAME" '.release.projects | index($pkg)' nx.json > /dev/null 2>&1; then
                    echo "$project:$PACKAGE_NAME"
                  fi
                fi
              fi
            fi
          done)

          echo "All release-configured packages:"
          echo "$ALL_PACKAGES"

          if [[ "$INPUT_PACKAGES" == "all" ]]; then
            # Use all release-configured packages
            SELECTED_PROJECTS=$(echo "$ALL_PACKAGES" | cut -d: -f1 | tr '\n' ',' | sed 's/,$//')
            SELECTED_PACKAGES=$(echo "$ALL_PACKAGES" | cut -d: -f2 | tr '\n' ',' | sed 's/,$//')
          else
            # Parse comma-separated input and match to projects
            SELECTED_PROJECTS=""
            SELECTED_PACKAGES=""
            IFS=',' read -ra INPUT_PKG_ARRAY <<< "$INPUT_PACKAGES"

            for input_pkg in "${INPUT_PKG_ARRAY[@]}"; do
              # Trim whitespace
              input_pkg=$(echo "$input_pkg" | xargs)

              # Find the matching project
              MATCH=$(echo "$ALL_PACKAGES" | grep ":${input_pkg}$" || echo "")

              if [ -z "$MATCH" ]; then
                echo "âŒ ERROR: Package '$input_pkg' not found in release configuration"
                echo "Available packages:"
                echo "$ALL_PACKAGES" | cut -d: -f2
                exit 1
              fi

              PROJECT=$(echo "$MATCH" | cut -d: -f1)
              PACKAGE=$(echo "$MATCH" | cut -d: -f2)

              if [ -n "$SELECTED_PROJECTS" ]; then
                SELECTED_PROJECTS="${SELECTED_PROJECTS},${PROJECT}"
                SELECTED_PACKAGES="${SELECTED_PACKAGES},${PACKAGE}"
              else
                SELECTED_PROJECTS="$PROJECT"
                SELECTED_PACKAGES="$PACKAGE"
              fi
            done
          fi

          echo "Selected Nx projects: $SELECTED_PROJECTS"
          echo "Selected npm packages: $SELECTED_PACKAGES"

          # Count packages
          PACKAGE_COUNT=$(echo "$SELECTED_PACKAGES" | tr ',' '\n' | grep -c '.' || echo "0")

          echo "projects=$SELECTED_PROJECTS" >> $GITHUB_OUTPUT
          echo "packages=$SELECTED_PACKAGES" >> $GITHUB_OUTPUT
          echo "package_count=$PACKAGE_COUNT" >> $GITHUB_OUTPUT

          if [ "$PACKAGE_COUNT" -eq "0" ]; then
            echo "âŒ ERROR: No packages selected for publishing"
            exit 1
          fi

          echo "âœ… Resolved $PACKAGE_COUNT package(s) for publishing"

  publish:
    name: Force publish packages
    needs: validate
    uses: ./.github/workflows/publish-packages.yml
    with:
      projects: ${{ needs.validate.outputs.projects }}
      packages: ${{ needs.validate.outputs.packages }}
      npm_tag: "next"
      version_strategy: "prerelease"
      preid: "next"
      branch: "next"
      dry_run: ${{ github.event.inputs.dryRun == 'true' }}
      clean_orphaned_tags: false
      is_prerelease: true
    secrets:
      WORKFLOW_PAT: ${{ secrets.WORKFLOW_PAT }}
      NODE_AUTH_TOKEN: ${{ secrets.NODE_AUTH_TOKEN }}
      SERVICE_ACCOUNT_GPG_PRIVATE_KEY: ${{ secrets.SERVICE_ACCOUNT_GPG_PRIVATE_KEY }}

  summary:
    name: Generate summary
    runs-on: ubuntu-24.04
    needs: [validate, publish]
    if: always()

    steps:
      - name: Generate workflow summary
        env:
          DRY_RUN: ${{ github.event.inputs.dryRun }}
          BRANCH_NAME: ${{ github.ref_name }}
          PACKAGE_COUNT: ${{ needs.validate.outputs.package_count }}
          SUCCESSFUL_COUNT: ${{ needs.publish.outputs.successful_count || '0' }}
          FAILED_COUNT: ${{ needs.publish.outputs.failed_count || '0' }}
          SUCCESSFUL_PACKAGES: ${{ needs.publish.outputs.successful_packages }}
          FAILED_PACKAGES: ${{ needs.publish.outputs.failed_packages }}
        run: |
          echo "## ðŸš€ Force Publish Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$DRY_RUN" = "true" ]; then
            echo "**Mode:** Dry Run (no changes made)" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Mode:** Live Publish" >> $GITHUB_STEP_SUMMARY
          fi

          echo "**Branch:** $BRANCH_NAME" >> $GITHUB_STEP_SUMMARY
          echo "**Packages requested:** $PACKAGE_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$DRY_RUN" != "true" ]; then
            echo "### Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Successful:** $SUCCESSFUL_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "- **Failed:** $FAILED_COUNT" >> $GITHUB_STEP_SUMMARY

            if [ -n "$SUCCESSFUL_PACKAGES" ] && [ "$SUCCESSFUL_PACKAGES" != "null" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "#### Successfully Published" >> $GITHUB_STEP_SUMMARY
              echo "$SUCCESSFUL_PACKAGES" | jq -r '.[]' 2>/dev/null | while read pkg; do
                if [ -n "$pkg" ]; then
                  echo "- âœ… $pkg" >> $GITHUB_STEP_SUMMARY
                fi
              done
            fi

            if [ "$FAILED_COUNT" != "0" ] && [ -n "$FAILED_PACKAGES" ] && [ "$FAILED_PACKAGES" != "null" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "#### Failed" >> $GITHUB_STEP_SUMMARY
              echo "$FAILED_PACKAGES" | jq -r '.[]' 2>/dev/null | while read pkg; do
                if [ -n "$pkg" ]; then
                  echo "- âŒ $pkg" >> $GITHUB_STEP_SUMMARY
                fi
              done
            fi
          fi
