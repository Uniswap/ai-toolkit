name: Update Production

# This workflow automatically creates production release PRs from the `next` branch.
# It runs on a weekly schedule (Mondays at 5pm UTC / 1pm EDT) and can also be triggered manually.
#
# REQUIRED SECRETS:
# 1. WORKFLOW_PAT: Personal Access Token with 'repo' and 'workflow' scopes
#    - Required to trigger the publish-packages workflow after PR merge
#    - Create at: GitHub Settings > Developer settings > Personal access tokens
# 2. SLACK_WEBHOOK_URL: Incoming webhook URL for #ai-internal Slack channel
#    - Required to send notifications about new PRs
#    - Create at: https://api.slack.com/apps > Incoming Webhooks
#
# WORKFLOW BEHAVIOR:
# - Creates a temporary release branch from `next`
# - Opens PR to `main` with categorized changelog
# - Assigns reviewers: @wkoutre and @Melvillian
# - Sends notification to #ai-internal Slack channel
# - Awaits manual review and merge (does NOT auto-merge)
# - After merge, publish-packages workflow runs automatically

on:
  schedule:
    # Runs every Monday at 5pm UTC (1pm EDT during daylight saving time)
    # Note: During EST (Nov-Mar), this will run at 12pm EST
    - cron: '0 17 * * 1'
  workflow_dispatch:

jobs:
  create-and-merge-pr:
    runs-on: ubuntu-24.04
    # Only allow this workflow to run from the next branch
    if: github.ref == 'refs/heads/next'
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11
        with:
          fetch-depth: 0
          # Use PAT if available to allow triggering downstream workflows, fallback to GITHUB_TOKEN
          token: ${{ secrets.WORKFLOW_PAT || secrets.GITHUB_TOKEN }}

      - name: Install GitHub CLI
        run: |
          # GitHub CLI should be pre-installed on ubuntu-latest runners
          # But let's verify it's available
          which gh || (echo "GitHub CLI not found" && exit 1)
          gh --version

      - name: Configure Git
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

      - name: Create temporary branch and PR
        id: create-pr
        env:
          GITHUB_TOKEN: ${{ secrets.WORKFLOW_PAT || secrets.GITHUB_TOKEN }}
        run: |
          # Fetch latest branches
          git fetch origin

          # Debug: Show current branch and remote branches
          echo "Current branch: $(git branch --show-current)"
          echo "Remote branches:"
          git branch -r

          # Get commit count difference (using origin/main vs origin/next)
          COMMIT_COUNT=$(git rev-list --count origin/main..origin/next || echo "0")
          echo "Commit count difference: $COMMIT_COUNT"

          if [ "$COMMIT_COUNT" -eq "0" ]; then
            echo "No new commits to merge from next to main"
            echo "pr_created=false" >> $GITHUB_OUTPUT
            echo "Skipping PR creation as there are no new commits"
          else
            echo "Found $COMMIT_COUNT new commits to merge"

            # Generate timestamp for unique branch name
            TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
            TEMP_BRANCH="release/next-to-main-$TIMESTAMP"
            
            # Create and push temporary branch from next
            echo "Creating temporary branch: $TEMP_BRANCH"
            git checkout -b "$TEMP_BRANCH" origin/next
            git push origin "$TEMP_BRANCH"

            # Generate PR title with date
            DATE=$(date +'%Y-%m-%d')
            PR_TITLE="chore: promote next to production ($DATE)"

            # Generate PR body with commit list
            PR_BODY="## Production Deployment

            This PR promotes the \`next\` branch to \`main\` for production release.

            ### Commits included ($COMMIT_COUNT):
            \`\`\`
            $(git log origin/main..HEAD --oneline)
            \`\`\`

            ### Merge Strategy
            Using **merge commit** to preserve full commit history for changelog generation.

            ### Temporary Branch
            This PR is created from a temporary branch \`$TEMP_BRANCH\` that will be deleted after merge.

            ---
            *This PR was automatically created by the Update Production workflow.*"

            # Check if a PR already exists from any release branch
            EXISTING_PR=$(gh pr list --base main --state open --json number,headRefName --jq '.[] | select(.headRefName | startswith("release/next-to-main-")) | .number' | head -n1 || echo "")

            if [ -n "$EXISTING_PR" ]; then
              echo "PR #$EXISTING_PR already exists for a release branch"
              
              # Get the existing PR's branch name
              OLD_BRANCH=$(gh pr view $EXISTING_PR --json headRefName --jq '.headRefName')
              echo "Existing PR branch: $OLD_BRANCH"
              
              # Close the existing PR
              gh pr close $EXISTING_PR --comment "Closing in favor of new release branch: $TEMP_BRANCH"
              
              # Delete the old branch
              git push origin --delete "$OLD_BRANCH" || echo "Could not delete old branch $OLD_BRANCH"
              
              # Create new PR
              PR_URL=$(gh pr create \
                --base main \
                --head "$TEMP_BRANCH" \
                --title "$PR_TITLE" \
                --body "$PR_BODY" \
                2>&1)

              # Extract PR number from URL
              PR_NUMBER=$(echo "$PR_URL" | grep -oE '[0-9]+$')

              echo "Created new PR #$PR_NUMBER to replace #$EXISTING_PR"
            else
              # Create the PR using GitHub CLI
              PR_URL=$(gh pr create \
                --base main \
                --head "$TEMP_BRANCH" \
                --title "$PR_TITLE" \
                --body "$PR_BODY" \
                2>&1)

              # Extract PR number from URL
              PR_NUMBER=$(echo "$PR_URL" | grep -oE '[0-9]+$')

              echo "Created PR #$PR_NUMBER: $PR_URL"
            fi

            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
            echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
            echo "pr_created=true" >> $GITHUB_OUTPUT
            echo "temp_branch=$TEMP_BRANCH" >> $GITHUB_OUTPUT
          fi

      - name: Generate categorized changelog
        if: steps.create-pr.outputs.pr_created == 'true'
        id: changelog
        env:
          GITHUB_TOKEN: ${{ secrets.WORKFLOW_PAT || secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ steps.create-pr.outputs.pr_number }}

          # Generate categorized changelog
          echo "Generating categorized changelog..."

          # Initialize category arrays
          FEATURES=""
          FIXES=""
          DOCS=""
          CHORES=""
          OTHERS=""

          # Get all commits between main and next
          while IFS= read -r commit; do
            # Extract commit type from conventional commit format
            TYPE=$(echo "$commit" | grep -oE '^[a-z]+' || echo "other")
            MESSAGE=$(echo "$commit" | sed 's/^[a-z]*: //')

            case "$TYPE" in
              feat|feature)
                FEATURES="${FEATURES}- ${MESSAGE}\n"
                ;;
              fix)
                FIXES="${FIXES}- ${MESSAGE}\n"
                ;;
              docs|doc)
                DOCS="${DOCS}- ${MESSAGE}\n"
                ;;
              chore|build|ci|refactor|style|test|perf)
                CHORES="${CHORES}- ${MESSAGE}\n"
                ;;
              *)
                OTHERS="${OTHERS}- ${commit}\n"
                ;;
            esac
          done < <(git log origin/main..HEAD --oneline | sed 's/^[a-f0-9]* //')

          # Build changelog sections
          CHANGELOG="## Changes Summary\n\n"

          if [ -n "$FEATURES" ]; then
            FEATURE_COUNT=$(echo -e "$FEATURES" | grep -c "^-" || echo "0")
            CHANGELOG="${CHANGELOG}### ‚ú® Features (${FEATURE_COUNT})\n${FEATURES}\n"
          fi

          if [ -n "$FIXES" ]; then
            FIX_COUNT=$(echo -e "$FIXES" | grep -c "^-" || echo "0")
            CHANGELOG="${CHANGELOG}### üêõ Bug Fixes (${FIX_COUNT})\n${FIXES}\n"
          fi

          if [ -n "$DOCS" ]; then
            DOC_COUNT=$(echo -e "$DOCS" | grep -c "^-" || echo "0")
            CHANGELOG="${CHANGELOG}### üìù Documentation (${DOC_COUNT})\n${DOCS}\n"
          fi

          if [ -n "$CHORES" ]; then
            CHORE_COUNT=$(echo -e "$CHORES" | grep -c "^-" || echo "0")
            CHANGELOG="${CHANGELOG}### üîß Maintenance (${CHORE_COUNT})\n${CHORES}\n"
          fi

          if [ -n "$OTHERS" ]; then
            OTHER_COUNT=$(echo -e "$OTHERS" | grep -c "^-" || echo "0")
            CHANGELOG="${CHANGELOG}### üì¶ Other Changes (${OTHER_COUNT})\n${OTHERS}\n"
          fi

          # Add full commit list
          CHANGELOG="${CHANGELOG}### Full Commit List\n\`\`\`\n$(git log origin/main..HEAD --oneline)\n\`\`\`\n"

          # Get current PR body
          CURRENT_BODY=$(gh pr view $PR_NUMBER --json body --jq '.body')

          # Update PR with categorized changelog
          NEW_BODY="${CURRENT_BODY}\n\n${CHANGELOG}"

          # Use a temporary file to avoid issues with special characters
          echo -e "$NEW_BODY" > /tmp/pr_body.txt
          gh pr edit $PR_NUMBER --body-file /tmp/pr_body.txt

          echo "‚úÖ Categorized changelog added to PR #$PR_NUMBER"

      - name: Add reviewers
        if: steps.create-pr.outputs.pr_created == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.WORKFLOW_PAT || secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ steps.create-pr.outputs.pr_number }}

          echo "Adding reviewers to PR #$PR_NUMBER..."

          # Add reviewers
          gh pr edit $PR_NUMBER --add-reviewer wkoutre,Melvillian

          echo "‚úÖ Added reviewers: @wkoutre, @Melvillian"

      - name: Check PR mergeability
        if: steps.create-pr.outputs.pr_created == 'true'
        id: check-mergeable
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.WORKFLOW_PAT || secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ steps.create-pr.outputs.pr_number }}

          echo "Checking if PR #$PR_NUMBER is mergeable..."

          # Wait a bit for GitHub to compute mergeability
          sleep 10

          # Check PR mergeability status
          MERGEABLE=$(gh pr view $PR_NUMBER --json mergeable --jq '.mergeable')
          MERGE_STATE=$(gh pr view $PR_NUMBER --json mergeStateStatus --jq '.mergeStateStatus')

          echo "Mergeable: $MERGEABLE"
          echo "Merge State: $MERGE_STATE"
          echo "mergeable=$MERGEABLE" >> $GITHUB_OUTPUT
          echo "merge_state=$MERGE_STATE" >> $GITHUB_OUTPUT

          if [ "$MERGEABLE" = "CONFLICTING" ]; then
            echo "‚ö†Ô∏è PR has merge conflicts!"
            echo "has_conflicts=true" >> $GITHUB_OUTPUT
            exit 1
          elif [ "$MERGEABLE" = "MERGEABLE" ]; then
            echo "‚úÖ PR is mergeable"
            echo "has_conflicts=false" >> $GITHUB_OUTPUT
          else
            echo "‚ÑπÔ∏è Mergeability status: $MERGEABLE"
            echo "has_conflicts=unknown" >> $GITHUB_OUTPUT
          fi

      - name: Send Slack notification (Success)
        if: steps.create-pr.outputs.pr_created == 'true' && steps.check-mergeable.outputs.has_conflicts != 'true'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          PR_NUMBER=${{ steps.create-pr.outputs.pr_number }}
          PR_URL=${{ steps.create-pr.outputs.pr_url }}

          # Get commit count
          COMMIT_COUNT=$(git rev-list --count origin/main..origin/next)

          echo "Sending Slack notification..."

          # Send notification to Slack
          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d "{
              \"text\": \"üì¶ *Production Release PR Ready for Review*\",
              \"blocks\": [
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"üì¶ *Production Release PR Ready for Review*\n\nA new production release PR has been automatically created and is ready for review.\"
                  }
                },
                {
                  \"type\": \"section\",
                  \"fields\": [
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*PR Number:*\n#${PR_NUMBER}\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Commits:*\n${COMMIT_COUNT} changes\"
                    }
                  ]
                },
                {
                  \"type\": \"section\",
                  \"fields\": [
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Reviewers:*\n@wkoutre @Melvillian\"
                    }
                  ]
                },
                {
                  \"type\": \"actions\",
                  \"elements\": [
                    {
                      \"type\": \"button\",
                      \"text\": {
                        \"type\": \"plain_text\",
                        \"text\": \"Review PR\"
                      },
                      \"url\": \"${PR_URL}\",
                      \"style\": \"primary\"
                    }
                  ]
                }
              ]
            }"

          echo "‚úÖ Slack notification sent to #ai-internal"

      - name: Send Slack notification (Merge Conflicts)
        if: always() && steps.create-pr.outputs.pr_created == 'true' && steps.check-mergeable.outputs.has_conflicts == 'true'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          PR_NUMBER=${{ steps.create-pr.outputs.pr_number }}
          PR_URL=${{ steps.create-pr.outputs.pr_url }}

          echo "Sending merge conflict notification to Slack..."

          # Send conflict notification to Slack
          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d "{
              \"text\": \"‚ö†Ô∏è *Production Release PR Has Merge Conflicts* <!subteam^S07V1686BBE>\",
              \"blocks\": [
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"‚ö†Ô∏è *Production Release PR Has Merge Conflicts*\n\n<!subteam^S07V1686BBE> The production release PR has merge conflicts and requires manual intervention.\"
                  }
                },
                {
                  \"type\": \"section\",
                  \"fields\": [
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*PR Number:*\n#${PR_NUMBER}\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Status:*\nMerge Conflicts\"
                    }
                  ]
                },
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*Action Required:*\nPlease resolve the merge conflicts manually and complete the merge to production.\"
                  }
                },
                {
                  \"type\": \"actions\",
                  \"elements\": [
                    {
                      \"type\": \"button\",
                      \"text\": {
                        \"type\": \"plain_text\",
                        \"text\": \"View PR & Resolve Conflicts\"
                      },
                      \"url\": \"${PR_URL}\",
                      \"style\": \"danger\"
                    }
                  ]
                }
              ]
            }"

          echo "‚úÖ Merge conflict notification sent to #ai-internal"

      - name: Cleanup temporary branch on failure
        if: failure() && steps.create-pr.outputs.temp_branch != '' && steps.check-mergeable.outputs.has_conflicts != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.WORKFLOW_PAT || secrets.GITHUB_TOKEN }}
        run: |
          TEMP_BRANCH="${{ steps.create-pr.outputs.temp_branch }}"
          PR_NUMBER="${{ steps.create-pr.outputs.pr_number }}"

          echo "Workflow failed for non-conflict reason. Cleaning up..."
          echo "Temporary branch: $TEMP_BRANCH"

          # Only close the PR and cleanup if the failure was NOT due to merge conflicts
          # (merge conflicts should keep the PR open for manual resolution)
          if [ -n "$PR_NUMBER" ]; then
            gh pr close $PR_NUMBER --comment "Workflow failed or was cancelled. Closing PR and cleaning up temporary branch." || true
          fi

          # Delete the temporary branch
          git push origin --delete "$TEMP_BRANCH" || echo "Could not delete temporary branch $TEMP_BRANCH"

      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.create-pr.outputs.pr_created }}" = "true" ]; then
            echo "## üì¶ Production Release PR Created" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **PR Number**: #${{ steps.create-pr.outputs.pr_number }}" >> $GITHUB_STEP_SUMMARY
            echo "- **PR URL**: ${{ steps.create-pr.outputs.pr_url }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Temporary Branch**: ${{ steps.create-pr.outputs.temp_branch }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Reviewers**: @wkoutre, @Melvillian" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "A production release PR has been created from the \`next\` branch." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Next steps:" >> $GITHUB_STEP_SUMMARY
            echo "1. ‚úÖ PR created with categorized changelog" >> $GITHUB_STEP_SUMMARY
            echo "2. ‚úÖ Reviewers assigned (@wkoutre, @Melvillian)" >> $GITHUB_STEP_SUMMARY
            echo "3. ‚úÖ Slack notification sent to #ai-internal" >> $GITHUB_STEP_SUMMARY
            echo "4. ‚è≥ **Awaiting review and approval**" >> $GITHUB_STEP_SUMMARY
            echo "5. ‚è≥ After merge, publish-packages workflow will run automatically" >> $GITHUB_STEP_SUMMARY
            echo "6. ‚è≥ Packages will be published with the \`latest\` tag" >> $GITHUB_STEP_SUMMARY
            echo "7. üßπ Temporary branch will be deleted automatically after merge" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ‚ÑπÔ∏è No Updates Required" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The \`next\` branch has no new commits to merge into \`main\`." >> $GITHUB_STEP_SUMMARY
          fi
