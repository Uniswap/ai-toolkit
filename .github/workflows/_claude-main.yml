# Reusable workflow for Claude Code in GitHub Actions
#
# This workflow enables Claude to respond to @claude mentions in:
# - Issue comments
# - Pull request comments
# - Pull request review comments
# - Pull request reviews
# - New issues
#
# It includes:
# - Security scanning with bullfrog (fixed, cannot be overridden)
# - Fixed trigger conditions and bot filtering
# - Fixed permissions for safe operation
# - Configurable model, tools, and execution parameters
#
# USAGE:
# Call this workflow from your repository's workflow:
#
# name: Claude Code
# on:
#   issue_comment:
#     types: [created]
#   pull_request_review_comment:
#     types: [created]
#   issues:
#     types: [opened, assigned]
#   pull_request_review:
#     types: [submitted]
#
# jobs:
#   claude:
#     if: |
#       (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude') && github.event.comment.user.type != 'Bot') ||
#       (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude') && github.event.comment.user.type != 'Bot') ||
#       (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude') && github.event.review.user.type != 'Bot') ||
#       (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')) && github.event.issue.user.type != 'Bot')
#     uses: Uniswap/ai-toolkit/.github/workflows/_claude-main.yml@main
#     secrets:
#       ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
#     with:
#       model: 'claude-sonnet-4-5-20250929'
#
# INPUTS:
# - prompt (optional): Direct automation prompt (enables automation mode)
# - model (optional): Claude model to use (default: claude-sonnet-4-5-20250929)
# - allowed_tools (optional): Comma-separated list of allowed tools
# - disallowed_tools (optional): Comma-separated list of disallowed tools
# - custom_instructions (optional): Additional instructions for Claude (system prompt)
# - max_turns (optional): Maximum conversation turns
# - mcp_config (optional): MCP server configuration (JSON)
# - settings (optional): Additional settings including env vars (JSON)
# - timeout_minutes (optional): Job timeout in minutes (default: 10)
# - anthropic_api_key_secret_name (optional): Name of the secret containing the Anthropic API key (default: ANTHROPIC_API_KEY)
#
# SECRETS (at least one required):
# - ANTHROPIC_API_KEY: Anthropic API key (or custom secret name via anthropic_api_key_secret_name input)
# - CLAUDE_CODE_OAUTH_TOKEN: OAuth token for Claude Code (alternative to API key, takes precedence if both set)
#
# FIXED SETTINGS (cannot be overridden):
# - Security: bullfrog egress-policy: audit
# - Permissions: id-token: write, contents: read, pull-requests: write, issues: write, actions: read
# - Checkout: fetch-depth: 50
# - Trigger conditions: @claude mentions with bot filtering

name: "[claude] Claude Code"

on:
  workflow_call:
    inputs:
      prompt:
        description: "Direct automation prompt for Claude. When provided, Claude runs in automation mode instead of interactive @mention mode. Supports GitHub context variables."
        required: false
        type: string
        default: ""

      model:
        description: |
          Claude model to use for this execution.

          Available models:
          - claude-sonnet-4-5-20250929 (default, recommended) - Latest Sonnet model with best balance of speed and capability
          - claude-opus-4-5-20251101 - Most capable model for complex tasks
          - claude-haiku-4-5@20251001 - Fast, cost-effective model for simpler tasks

          Default: claude-sonnet-4-5-20250929
        required: false
        type: string
        default: "claude-opus-4-5-20251101"

      allowed_tools:
        description: |
          Comma-separated list of tools Claude can use.

          If not provided, uses permissive defaults (all file operations and bash commands).

          Example (restrictive):
          allowed_tools: "Read,Grep,Glob,Bash"

          Available tools: Read, Write, Edit, Glob, Grep, Bash, WebSearch, WebFetch, etc.
          See https://github.com/anthropics/claude-code-action for full tool reference.
        required: false
        type: string
        default: ""

      disallowed_tools:
        description: |
          Comma-separated list of tools to disable for Claude.
          Takes precedence over allowed_tools.

          Example:
          disallowed_tools: "WebSearch,WebFetch"

          Useful when you want to allow most tools but disable specific ones.
        required: false
        type: string
        default: ""

      custom_instructions:
        description: |
          Additional instructions for Claude to follow (system prompt).
          These are appended to the default instructions.

          Default instructions always include:
          "Be sure to follow rules in all CLAUDE.md files."

          Example:
          custom_instructions: |
            When reviewing PRs, focus on:
            - Security vulnerabilities
            - Performance implications
            - Test coverage
        required: false
        type: string
        default: "Be sure to follow rules in all CLAUDE.md files."

      max_turns:
        description: |
          Maximum number of conversation turns Claude can take.
          Useful for controlling execution length and costs.

          Default: unlimited
          Recommended: 10-20 for most tasks
        required: false
        type: string
        default: ""

      mcp_config:
        description: |
          MCP (Model Context Protocol) server configuration as JSON string.

          Example:
          mcp_config: |
            {
              "mcpServers": {
                "my-server": {
                  "command": "node",
                  "args": ["server.js"]
                }
              }
            }
        required: false
        type: string
        default: ""

      settings:
        description: |
          Additional settings in JSON format, including environment variables.

          Example:
          settings: |
            {
              "env": {
                "NODE_ENV": "test",
                "CI": "true"
              }
            }
        required: false
        type: string
        default: ""

      timeout_minutes:
        description: |
          Maximum execution time for Claude in minutes.
          Prevents runaway executions and controls costs.

          Default: 10 minutes
          Recommended range: 5-15 minutes

          Note: This sets the GitHub Actions job timeout, not a Claude CLI argument.
        required: false
        type: number
        default: 10

      anthropic_api_key_secret_name:
        description: |
          Name of the repository secret containing the Anthropic API key.

          Default: ANTHROPIC_API_KEY

          Use this if your repository uses a different secret name for the API key.
        required: false
        type: string
        default: "ANTHROPIC_API_KEY"

      toolkit_ref:
        description: |
          Git ref (branch, tag, or SHA) of ai-toolkit to use for downloading
          the validate-claude-auth action. Defaults to 'main'.

          Use 'next' or a specific SHA to test unreleased changes.
        required: false
        type: string
        default: "main"

      plugin_marketplaces:
        description: |
          Additional plugin marketplace paths beyond uniswap-ai-toolkit (if enabled).
          Newline-separated list of local paths or Git URLs.

          Example:
          plugin_marketplaces: |
            ./custom-plugins
            https://github.com/org/marketplace.git
        required: false
        type: string
        default: ""

      plugins:
        description: |
          Additional plugins to install beyond the uniswap-ai-toolkit plugins.
          Newline-separated list in 'plugin-name@marketplace-name' format.

          Example:
          plugins: |
            code-review@my-marketplace
            pr-helper@my-marketplace
        required: false
        type: string
        default: ""

      install_uniswap_plugins:
        description: |
          Whether to install the uniswap-ai-toolkit plugins automatically.

          When true (default): All 5 uniswap-ai-toolkit plugins are installed:
          - development-planning
          - development-pr-workflow
          - development-codebase-tools
          - development-productivity
          - uniswap-integrations

          When false: No uniswap plugins are installed. Use this if you want to
          use only your own plugins via plugin_marketplaces and plugins inputs.
        required: false
        type: boolean
        default: true

    secrets:
      ANTHROPIC_API_KEY:
        description: "Anthropic API key for Claude Code. Required unless CLAUDE_CODE_OAUTH_TOKEN is provided."
        required: false
      CLAUDE_CODE_OAUTH_TOKEN:
        description: "Claude Code OAuth token for authentication. Alternative to ANTHROPIC_API_KEY. When provided, takes precedence over API key. Generate with 'claude setup-token'."
        required: false

jobs:
  claude:
    runs-on: ubuntu-latest
    timeout-minutes: ${{ inputs.timeout_minutes }}

    # FIXED: These permissions cannot be overridden
    # They provide the minimum required access for Claude to function safely
    permissions:
      id-token: write # Required for OIDC authentication
      contents: read # Required to read repository code
      pull-requests: write # Required to comment on PRs
      issues: write # Required to comment on issues
      actions: read # Required to read CI results on PRs

    # Prevent concurrent executions for the same issue/PR
    concurrency:
      group: claude-main-${{ github.event.issue.number || github.event.pull_request.number }}
      cancel-in-progress: true

    steps:
      # FIXED: Security scanning with bullfrog
      # This step cannot be disabled or modified
      - name: Security scanning
        uses: bullfrogsec/bullfrog@1831f79cce8ad602eef14d2163873f27081ebfb3 # v0.8.4
        with:
          egress-policy: audit

      # FIXED: Checkout with consistent fetch depth
      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 50

      # Download validate-claude-auth action if caller repo doesn't have it
      # This allows external repos to use this reusable workflow without copying the action
      - name: Ensure validate-claude-auth action exists
        env:
          TOOLKIT_REF: ${{ inputs.toolkit_ref }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ACTION_FILE=".github/actions/validate-claude-auth/action.yml"

          if [ -f "$ACTION_FILE" ]; then
            echo "Using local validate-claude-auth action"
          else
            echo "Downloading validate-claude-auth action from ai-toolkit@${TOOLKIT_REF}..."
            mkdir -p .github/actions/validate-claude-auth

            # Use GitHub API (same pattern as other reusable workflows)
            # Authentication required to avoid GitHub API rate limits on shared runner IPs
            if ! curl -fSs --max-time 30 --max-redirs 3 \
                      -H "Accept: application/vnd.github.v4.raw" \
                      -H "Authorization: Bearer $GITHUB_TOKEN" \
                      -L "https://api.github.com/repos/Uniswap/ai-toolkit/contents/.github/actions/validate-claude-auth/action.yml?ref=${TOOLKIT_REF}" \
                      -o "$ACTION_FILE" 2>&1 | tee /tmp/curl-error.log; then
              echo "::error::Failed to download validate-claude-auth action from ai-toolkit@${TOOLKIT_REF}"
              cat /tmp/curl-error.log
              exit 1
            fi

            # Verify the file was downloaded and has content
            if [ ! -s "$ACTION_FILE" ]; then
              echo "::error::Downloaded action.yml is empty"
              exit 1
            fi

            # Verify it's a valid action file (has 'runs:' section)
            if ! grep -q "^runs:" "$ACTION_FILE"; then
              echo "::error::Downloaded action.yml is invalid (missing 'runs:' section)"
              echo "File contents:"
              cat "$ACTION_FILE"
              exit 1
            fi

            echo "Successfully downloaded validate-claude-auth action from ai-toolkit@${TOOLKIT_REF}"
          fi

      - name: Validate Authentication
        uses: ./.github/actions/validate-claude-auth
        with:
          anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude-oauth-token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

      # Build claude_args with CLI arguments
      - name: Build Claude CLI arguments
        id: build-args
        env:
          INPUT_MODEL: ${{ inputs.model }}
          INPUT_ALLOWED_TOOLS: ${{ inputs.allowed_tools }}
          INPUT_DISALLOWED_TOOLS: ${{ inputs.disallowed_tools }}
          INPUT_CUSTOM_INSTRUCTIONS: ${{ inputs.custom_instructions }}
          INPUT_MAX_TURNS: ${{ inputs.max_turns }}
          INPUT_MCP_CONFIG: ${{ inputs.mcp_config }}
        run: |
          ARGS=""

          # Add model
          if [[ -n "$INPUT_MODEL" ]]; then
            ARGS="$ARGS--model $INPUT_MODEL"$'\n'
          fi

          # Add allowed tools (camelCase format)
          if [[ -n "$INPUT_ALLOWED_TOOLS" ]]; then
            ARGS="$ARGS--allowedTools $INPUT_ALLOWED_TOOLS"$'\n'
          fi

          # Add disallowed tools
          if [[ -n "$INPUT_DISALLOWED_TOOLS" ]]; then
            ARGS="$ARGS--disallowedTools $INPUT_DISALLOWED_TOOLS"$'\n'
          fi

          # Add system prompt
          if [[ -n "$INPUT_CUSTOM_INSTRUCTIONS" ]]; then
            ARGS="$ARGS--system-prompt \"$INPUT_CUSTOM_INSTRUCTIONS\""$'\n'
          fi

          # Add max turns
          if [[ -n "$INPUT_MAX_TURNS" ]]; then
            ARGS="$ARGS--max-turns $INPUT_MAX_TURNS"$'\n'
          fi

          # Add MCP config
          if [[ -n "$INPUT_MCP_CONFIG" ]]; then
            ARGS="$ARGS--mcp-config '$INPUT_MCP_CONFIG'"$'\n'
          fi

          echo "claude_args<<EOF" >> $GITHUB_OUTPUT
          echo "$ARGS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # Setup Uniswap AI Toolkit plugins
      # Downloads marketplace and plugins from ai-toolkit for external repositories
      # This ensures all Claude Code sessions have access to the full plugin suite
      - name: Setup Uniswap AI Toolkit plugins
        if: inputs.install_uniswap_plugins != false
        id: setup-uniswap-plugins
        env:
          TOOLKIT_REF: ${{ inputs.toolkit_ref }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          # Check if we're running from the ai-toolkit repository
          if [ "$GITHUB_REPOSITORY" = "Uniswap/ai-toolkit" ]; then
            echo "‚ÑπÔ∏è  Running from ai-toolkit - using local plugins"
            echo "use_local=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "‚ÑπÔ∏è  Running from external repository - downloading plugins from Uniswap/ai-toolkit@${TOOLKIT_REF}"
          echo "use_local=false" >> $GITHUB_OUTPUT

          # Create temporary directory for download
          WORK_DIR=$(mktemp -d)
          cd "$WORK_DIR"

          # Download repository tarball
          echo "üì¶ Downloading ai-toolkit tarball..."
          TARBALL_URL="https://api.github.com/repos/Uniswap/ai-toolkit/tarball/${TOOLKIT_REF}"

          if ! curl -fSsL --max-time 60 \
                    -H "Accept: application/vnd.github+json" \
                    -H "Authorization: Bearer $GITHUB_TOKEN" \
                    -o ai-toolkit.tar.gz \
                    "$TARBALL_URL" 2>&1; then
            echo "::error::Failed to download ai-toolkit tarball from ${TOOLKIT_REF}"
            exit 1
          fi

          # Extract tarball
          echo "üìÇ Extracting tarball..."
          tar -xzf ai-toolkit.tar.gz
          EXTRACTED_DIR=$(ls -d Uniswap-ai-toolkit-* | head -1)

          if [ -z "$EXTRACTED_DIR" ]; then
            echo "::error::Failed to find extracted directory"
            exit 1
          fi

          # Copy marketplace to workspace
          DEST_MARKETPLACE="${GITHUB_WORKSPACE}/.claude-plugin"
          mkdir -p "$DEST_MARKETPLACE"

          if [ -f "${EXTRACTED_DIR}/.claude-plugin/marketplace.json" ]; then
            cp "${EXTRACTED_DIR}/.claude-plugin/marketplace.json" "$DEST_MARKETPLACE/"
            echo "‚úÖ Copied marketplace.json"
          else
            echo "::error::marketplace.json not found in ai-toolkit"
            exit 1
          fi

          # Copy plugin directories
          DEST_PLUGINS="${GITHUB_WORKSPACE}/packages/plugins"
          mkdir -p "$DEST_PLUGINS"

          for plugin_dir in "${EXTRACTED_DIR}"/packages/plugins/*/; do
            plugin_name=$(basename "$plugin_dir")
            echo "üìÅ Copying plugin: $plugin_name"
            cp -r "$plugin_dir" "$DEST_PLUGINS/"
          done

          # Verify plugin structure
          PLUGIN_COUNT=$(jq '.plugins | length' "$DEST_MARKETPLACE/marketplace.json")
          echo "‚úÖ Setup complete: $PLUGIN_COUNT plugins installed"

          # Cleanup
          cd "${GITHUB_WORKSPACE}"
          rm -rf "$WORK_DIR"

      # Build plugin configuration
      # Configures uniswap-ai-toolkit plugins (if enabled) plus any additional plugins from inputs
      - name: Build plugin configuration
        id: build-plugins
        env:
          INSTALL_UNISWAP_PLUGINS: ${{ inputs.install_uniswap_plugins }}
          EXTRA_MARKETPLACES: ${{ inputs.plugin_marketplaces }}
          EXTRA_PLUGINS: ${{ inputs.plugins }}
        run: |
          MARKETPLACES=""
          PLUGINS=""

          # Include uniswap-ai-toolkit marketplace (unless opt-out is set)
          MARKETPLACE_FILE=".claude-plugin/marketplace.json"
          if [[ "$INSTALL_UNISWAP_PLUGINS" != "false" ]] && [[ -f "$MARKETPLACE_FILE" ]]; then
            echo "Found marketplace: $MARKETPLACE_FILE"

            # Add the marketplace directory as a local path
            MARKETPLACES="./.claude-plugin"$'\n'

            # Get marketplace name for plugin references
            MARKETPLACE_NAME=$(jq -r '.name' "$MARKETPLACE_FILE")
            echo "Marketplace name: $MARKETPLACE_NAME"

            # Build plugins list from marketplace
            PLUGIN_COUNT=$(jq '.plugins | length' "$MARKETPLACE_FILE")
            echo "Found $PLUGIN_COUNT plugins in marketplace"

            for i in $(seq 0 $((PLUGIN_COUNT - 1))); do
              PLUGIN_NAME=$(jq -r ".plugins[$i].name" "$MARKETPLACE_FILE")
              PLUGINS="${PLUGINS}${PLUGIN_NAME}@${MARKETPLACE_NAME}"$'\n'
              echo "  - $PLUGIN_NAME@$MARKETPLACE_NAME"
            done
          elif [[ "$INSTALL_UNISWAP_PLUGINS" == "false" ]]; then
            echo "Skipping uniswap-ai-toolkit plugins (install_uniswap_plugins=false)"
          else
            echo "::warning::No marketplace found at $MARKETPLACE_FILE"
          fi

          # Add extra marketplaces from inputs
          if [[ -n "$EXTRA_MARKETPLACES" ]]; then
            MARKETPLACES="${MARKETPLACES}${EXTRA_MARKETPLACES}"$'\n'
          fi

          # Add extra plugins from inputs
          if [[ -n "$EXTRA_PLUGINS" ]]; then
            PLUGINS="${PLUGINS}${EXTRA_PLUGINS}"$'\n'
          fi

          # Trim trailing newlines
          MARKETPLACES=$(echo -n "$MARKETPLACES" | sed '/^$/d')
          PLUGINS=$(echo -n "$PLUGINS" | sed '/^$/d')

          # Output results
          {
            echo "plugin_marketplaces<<EOF"
            echo "$MARKETPLACES"
            echo "EOF"
          } >> $GITHUB_OUTPUT

          {
            echo "plugins<<EOF"
            echo "$PLUGINS"
            echo "EOF"
          } >> $GITHUB_OUTPUT

          # Log configuration
          if [[ -n "$MARKETPLACES" ]]; then
            echo "Plugin marketplaces configured:"
            echo "$MARKETPLACES" | while read -r line; do
              [[ -n "$line" ]] && echo "  - $line"
            done
          else
            echo "No plugin marketplaces configured"
          fi

          if [[ -n "$PLUGINS" ]]; then
            echo "Plugins to install:"
            echo "$PLUGINS" | while read -r line; do
              [[ -n "$line" ]] && echo "  - $line"
            done
          else
            echo "No plugins configured"
          fi

      # Run Claude Code
      # Supports both API key and OAuth token authentication (validated in earlier step)
      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@1b8ee3b94104046d71fde52ec3557651ad8c0d71 # v1.0.29
        with:
          # Authentication: provide either API key or OAuth token (validated in earlier step)
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: ${{ inputs.prompt }}
          claude_args: ${{ steps.build-args.outputs.claude_args }}
          settings: ${{ inputs.settings }}
          # Plugin configuration (requires claude-code-action v1.0.28+)
          plugin_marketplaces: ${{ steps.build-plugins.outputs.plugin_marketplaces }}
          plugins: ${{ steps.build-plugins.outputs.plugins }}
          additional_permissions: |
            actions: read

      # Create job summary
      - name: Create job summary
        if: always()
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            // Build summary
            let summary = '# ü§ñ Claude Code Execution Summary\n\n';

            // Add status
            const conclusion = '${{ steps.claude.conclusion }}';
            if (conclusion === 'success') {
              summary += '‚úÖ **Status:** Completed successfully\n\n';
            } else if (conclusion === 'failure') {
              summary += '‚ùå **Status:** Failed\n\n';
            } else if (conclusion === 'cancelled') {
              summary += '‚è∏Ô∏è **Status:** Cancelled\n\n';
            } else {
              summary += '‚ö†Ô∏è **Status:** Unknown\n\n';
            }

            // Add configuration
            summary += '**Configuration:**\n';
            summary += `- Model: \`${{ inputs.model }}\`\n`;
            summary += `- Timeout: ${{ inputs.timeout_minutes }} minutes\n`;

            if ('${{ inputs.prompt }}') {
              summary += '- Mode: Automation (direct prompt)\n';
            } else {
              summary += '- Mode: Interactive (@claude mentions)\n';
            }

            if ('${{ inputs.allowed_tools }}') {
              summary += `- Allowed Tools: \`${{ inputs.allowed_tools }}\`\n`;
            } else {
              summary += '- Tools: Default (permissive)\n';
            }

            if ('${{ inputs.disallowed_tools }}') {
              summary += `- Disallowed Tools: \`${{ inputs.disallowed_tools }}\`\n`;
            }

            if ('${{ inputs.max_turns }}') {
              summary += `- Max Turns: ${{ inputs.max_turns }}\n`;
            }

            // Add context
            summary += '\n**Context:**\n';
            summary += `- Event: \`${{ github.event_name }}\`\n`;
            summary += `- Repository: \`${{ github.repository }}\`\n`;
            if (context.issue.number) {
              summary += `- Issue/PR: #${context.issue.number}\n`;
            }

            // Write summary
            await core.summary.addRaw(summary).write();
