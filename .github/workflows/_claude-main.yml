# Reusable workflow for Claude Code in GitHub Actions
#
# This workflow enables Claude to respond to @claude mentions in:
# - Issue comments
# - Pull request comments
# - Pull request review comments
# - Pull request reviews
# - New issues
#
# It includes:
# - Security scanning with bullfrog (fixed, cannot be overridden)
# - Fixed trigger conditions and bot filtering
# - Fixed permissions for safe operation
# - Configurable model, tools, and execution parameters
#
# USAGE:
# Call this workflow from your repository's workflow:
#
# name: Claude Code
# on:
#   issue_comment:
#     types: [created]
#   pull_request_review_comment:
#     types: [created]
#   issues:
#     types: [opened, assigned]
#   pull_request_review:
#     types: [submitted]
#
# jobs:
#   claude:
#     if: |
#       (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude') && github.event.comment.user.type != 'Bot') ||
#       (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude') && github.event.comment.user.type != 'Bot') ||
#       (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude') && github.event.review.user.type != 'Bot') ||
#       (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')) && github.event.issue.user.type != 'Bot')
#     uses: Uniswap/ai-toolkit/.github/workflows/_claude-main.yml@main
#     secrets:
#       ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
#     with:
#       model: 'claude-sonnet-4-5'
#
# INPUTS:
# - prompt (optional): Direct automation prompt (enables automation mode)
# - model (optional): Claude model to use (default: claude-sonnet-4-5)
# - allowed_tools (optional): Comma-separated list of allowed tools
# - disallowed_tools (optional): Comma-separated list of disallowed tools
# - custom_instructions (optional): Additional instructions for Claude (system prompt)
# - max_turns (optional): Maximum conversation turns
# - mcp_config (optional): MCP server configuration (JSON)
# - settings (optional): Additional settings including env vars (JSON)
# - timeout_minutes (optional): Job timeout in minutes (default: 10)
# - anthropic_api_key_secret_name (optional): Name of the secret containing the Anthropic API key (default: ANTHROPIC_API_KEY)
#
# SECRETS (at least one required):
# - ANTHROPIC_API_KEY: Anthropic API key (or custom secret name via anthropic_api_key_secret_name input)
# - CLAUDE_CODE_OAUTH_TOKEN: OAuth token for Claude Code (alternative to API key, takes precedence if both set)
#
# FIXED SETTINGS (cannot be overridden):
# - Security: bullfrog egress-policy: audit
# - Permissions: id-token: write, contents: read, pull-requests: write, issues: write, actions: read
# - Checkout: fetch-depth: 50
# - Trigger conditions: @claude mentions with bot filtering

name: "[claude] Claude Code"

on:
  workflow_call:
    inputs:
      prompt:
        description: "Direct automation prompt for Claude. When provided, Claude runs in automation mode instead of interactive @mention mode. Supports GitHub context variables."
        required: false
        type: string
        default: ""

      model:
        description: |
          Claude model to use for this execution.

          Available models:
          - claude-sonnet-4-5 (default, recommended) - Latest Sonnet model with best balance of speed and capability
          - claude-opus-4-6 - Most capable model for complex tasks
          - claude-haiku-4-5 - Fast, cost-effective model for simpler tasks

          Default: claude-sonnet-4-5
        required: false
        type: string
        default: "claude-sonnet-4-5"

      allowed_tools:
        description: |
          Comma-separated list of tools Claude can use.

          If not provided, uses permissive defaults (all file operations and bash commands).

          Example (restrictive):
          allowed_tools: "Read,Grep,Glob,Bash"

          Available tools: Read, Write, Edit, Glob, Grep, Bash, WebSearch, WebFetch, etc.
          See https://github.com/anthropics/claude-code-action for full tool reference.
        required: false
        type: string
        default: ""

      disallowed_tools:
        description: |
          Comma-separated list of tools to disable for Claude.
          Takes precedence over allowed_tools.

          Example:
          disallowed_tools: "WebSearch,WebFetch"

          Useful when you want to allow most tools but disable specific ones.
        required: false
        type: string
        default: ""

      custom_instructions:
        description: |
          Additional instructions for Claude to follow (system prompt).
          These are appended to the default instructions.

          Default instructions always include:
          "Be sure to follow rules in all CLAUDE.md files."

          Example:
          custom_instructions: |
            When reviewing PRs, focus on:
            - Security vulnerabilities
            - Performance implications
            - Test coverage
        required: false
        type: string
        default: "Be sure to follow rules in all CLAUDE.md files."

      max_turns:
        description: |
          Maximum number of conversation turns Claude can take.
          Useful for controlling execution length and costs.

          Default: unlimited
          Recommended: 10-20 for most tasks
        required: false
        type: string
        default: ""

      mcp_config:
        description: |
          MCP (Model Context Protocol) server configuration as JSON string.

          Example:
          mcp_config: |
            {
              "mcpServers": {
                "my-server": {
                  "command": "node",
                  "args": ["server.js"]
                }
              }
            }
        required: false
        type: string
        default: ""

      settings:
        description: |
          Additional settings in JSON format, including environment variables.

          Example:
          settings: |
            {
              "env": {
                "NODE_ENV": "test",
                "CI": "true"
              }
            }
        required: false
        type: string
        default: ""

      timeout_minutes:
        description: |
          Maximum execution time for Claude in minutes.
          Prevents runaway executions and controls costs.

          Default: 10 minutes
          Recommended range: 5-15 minutes

          Note: This sets the GitHub Actions job timeout, not a Claude CLI argument.
        required: false
        type: number
        default: 10

      anthropic_api_key_secret_name:
        description: |
          Name of the repository secret containing the Anthropic API key.

          Default: ANTHROPIC_API_KEY

          Use this if your repository uses a different secret name for the API key.
        required: false
        type: string
        default: "ANTHROPIC_API_KEY"

      toolkit_ref:
        description: |
          Git ref (branch, tag, or SHA) of ai-toolkit to use for downloading
          the validate-claude-auth action. Defaults to 'main'.

          Use 'next' or a specific SHA to test unreleased changes.
        required: false
        type: string
        default: "main"

      plugin_marketplaces:
        description: |
          Additional plugin marketplace paths beyond uniswap-ai-toolkit (if enabled).
          Newline-separated list of local paths or Git URLs.

          Example:
          plugin_marketplaces: |
            ./custom-plugins
            https://github.com/org/marketplace.git
        required: false
        type: string
        default: ""

      plugins:
        description: |
          Additional plugins to install beyond the uniswap-ai-toolkit plugins.
          Newline-separated list in 'plugin-name@marketplace-name' format.

          Example:
          plugins: |
            code-review@my-marketplace
            pr-helper@my-marketplace
        required: false
        type: string
        default: ""

      install_uniswap_plugins:
        description: |
          Whether to install the uniswap-ai-toolkit plugins automatically.

          When true (default): All 5 uniswap-ai-toolkit plugins are installed:
          - development-planning
          - development-pr-workflow
          - development-codebase-tools
          - development-productivity
          - uniswap-integrations

          When false: No uniswap plugins are installed. Use this if you want to
          use only your own plugins via plugin_marketplaces and plugins inputs.
        required: false
        type: boolean
        default: true

      plugin_ref:
        description: |
          Git ref of ai-toolkit to use for the build-plugin-config composite
          action. Must be 'main' (stable) or 'next' (pre-release). Defaults to
          'main'.
        required: false
        type: string
        default: "main"

    secrets:
      ANTHROPIC_API_KEY:
        description: "Anthropic API key for Claude Code. Required unless CLAUDE_CODE_OAUTH_TOKEN is provided."
        required: false
      CLAUDE_CODE_OAUTH_TOKEN:
        description: "Claude Code OAuth token for authentication. Alternative to ANTHROPIC_API_KEY. When provided, takes precedence over API key. Generate with 'claude setup-token'."
        required: false

jobs:
  claude:
    runs-on: ubuntu-latest
    timeout-minutes: ${{ inputs.timeout_minutes }}

    # FIXED: These permissions cannot be overridden
    # They provide the minimum required access for Claude to function safely
    permissions:
      id-token: write # Required for OIDC authentication
      contents: read # Required to read repository code
      pull-requests: write # Required to comment on PRs
      issues: write # Required to comment on issues
      actions: read # Required to read CI results on PRs

    # Prevent concurrent executions for the same issue/PR
    concurrency:
      group: claude-main-${{ github.event.issue.number || github.event.pull_request.number }}
      cancel-in-progress: true

    steps:
      # FIXED: Security scanning with bullfrog
      # This step cannot be disabled or modified
      - name: Security scanning
        uses: bullfrogsec/bullfrog@1831f79cce8ad602eef14d2163873f27081ebfb3 # v0.8.4
        with:
          egress-policy: audit

      # FIXED: Checkout with consistent fetch depth
      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 50
          persist-credentials: false

      # Download validate-claude-auth action if caller repo doesn't have it
      # This allows external repos to use this reusable workflow without copying the action
      - name: Ensure validate-claude-auth action exists
        env:
          TOOLKIT_REF: ${{ inputs.toolkit_ref }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ACTION_FILE=".github/actions/validate-claude-auth/action.yml"

          if [ -f "$ACTION_FILE" ]; then
            echo "Using local validate-claude-auth action"
          else
            echo "Downloading validate-claude-auth action from ai-toolkit@${TOOLKIT_REF}..."
            mkdir -p .github/actions/validate-claude-auth

            # Use GitHub API (same pattern as other reusable workflows)
            # Authentication required to avoid GitHub API rate limits on shared runner IPs
            if ! curl -fSs --max-time 30 --max-redirs 3 \
                      -H "Accept: application/vnd.github.v4.raw" \
                      -H "Authorization: Bearer $GITHUB_TOKEN" \
                      -L "https://api.github.com/repos/Uniswap/ai-toolkit/contents/.github/actions/validate-claude-auth/action.yml?ref=${TOOLKIT_REF}" \
                      -o "$ACTION_FILE" 2>&1 | tee /tmp/curl-error.log; then
              echo "::error::Failed to download validate-claude-auth action from ai-toolkit@${TOOLKIT_REF}"
              cat /tmp/curl-error.log
              exit 1
            fi

            # Verify the file was downloaded and has content
            if [ ! -s "$ACTION_FILE" ]; then
              echo "::error::Downloaded action.yml is empty"
              exit 1
            fi

            # Verify it's a valid action file (has 'runs:' section)
            if ! grep -q "^runs:" "$ACTION_FILE"; then
              echo "::error::Downloaded action.yml is invalid (missing 'runs:' section)"
              echo "File contents:"
              cat "$ACTION_FILE"
              exit 1
            fi

            echo "Successfully downloaded validate-claude-auth action from ai-toolkit@${TOOLKIT_REF}"
          fi

      - name: Validate Authentication
        uses: ./.github/actions/validate-claude-auth
        with:
          anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude-oauth-token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

      # Build claude_args with CLI arguments
      - name: Build Claude CLI arguments
        id: build-args
        env:
          INPUT_MODEL: ${{ inputs.model }}
          INPUT_ALLOWED_TOOLS: ${{ inputs.allowed_tools }}
          INPUT_DISALLOWED_TOOLS: ${{ inputs.disallowed_tools }}
          INPUT_CUSTOM_INSTRUCTIONS: ${{ inputs.custom_instructions }}
          INPUT_MAX_TURNS: ${{ inputs.max_turns }}
          INPUT_MCP_CONFIG: ${{ inputs.mcp_config }}
        run: |
          ARGS=""

          # Add model
          if [[ -n "$INPUT_MODEL" ]]; then
            ARGS="$ARGS--model $INPUT_MODEL"$'\n'
          fi

          # Add allowed tools (camelCase format)
          if [[ -n "$INPUT_ALLOWED_TOOLS" ]]; then
            ARGS="$ARGS--allowedTools $INPUT_ALLOWED_TOOLS"$'\n'
          fi

          # Add disallowed tools
          if [[ -n "$INPUT_DISALLOWED_TOOLS" ]]; then
            ARGS="$ARGS--disallowedTools $INPUT_DISALLOWED_TOOLS"$'\n'
          fi

          # Add system prompt
          if [[ -n "$INPUT_CUSTOM_INSTRUCTIONS" ]]; then
            ARGS="$ARGS--system-prompt \"$INPUT_CUSTOM_INSTRUCTIONS\""$'\n'
          fi

          # Add max turns
          if [[ -n "$INPUT_MAX_TURNS" ]]; then
            ARGS="$ARGS--max-turns $INPUT_MAX_TURNS"$'\n'
          fi

          # Add MCP config
          if [[ -n "$INPUT_MCP_CONFIG" ]]; then
            ARGS="$ARGS--mcp-config '$INPUT_MCP_CONFIG'"$'\n'
          fi

          echo "claude_args<<EOF" >> $GITHUB_OUTPUT
          echo "$ARGS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # Build plugin configuration using shared composite action
      # Note: GitHub Actions requires static refs in 'uses:', so we use conditional
      # steps instead of dynamic interpolation for security and predictability.
      - name: Build plugin configuration (main)
        id: build-plugins-main
        if: inputs.plugin_ref == 'main' || inputs.plugin_ref == ''
        uses: Uniswap/ai-toolkit/.github/actions/build-plugin-config@main # zizmor: ignore[unpinned-uses]
        with:
          install_uniswap_plugins: ${{ inputs.install_uniswap_plugins }}
          plugin_marketplaces: ${{ inputs.plugin_marketplaces }}
          plugins: ${{ inputs.plugins }}

      - name: Build plugin configuration (next)
        id: build-plugins-next
        if: inputs.plugin_ref == 'next'
        uses: Uniswap/ai-toolkit/.github/actions/build-plugin-config@next # zizmor: ignore[unpinned-uses]
        with:
          install_uniswap_plugins: ${{ inputs.install_uniswap_plugins }}
          plugin_marketplaces: ${{ inputs.plugin_marketplaces }}
          plugins: ${{ inputs.plugins }}

      # Run Claude Code
      # Supports both API key and OAuth token authentication (validated in earlier step)
      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@1b8ee3b94104046d71fde52ec3557651ad8c0d71 # v1.0.29
        with:
          # Authentication: provide either API key or OAuth token (validated in earlier step)
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: ${{ inputs.prompt }}
          claude_args: ${{ steps.build-args.outputs.claude_args }}
          settings: ${{ inputs.settings }}
          # Plugin configuration (requires claude-code-action v1.0.28+)
          # Coalesce outputs from conditional steps (only one will have run)
          plugin_marketplaces: ${{ steps.build-plugins-main.outputs.plugin_marketplaces || steps.build-plugins-next.outputs.plugin_marketplaces }}
          plugins: ${{ steps.build-plugins-main.outputs.plugins || steps.build-plugins-next.outputs.plugins }}
          additional_permissions: |
            actions: read

      # Create job summary
      - name: Create job summary
        if: always()
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        env:
          CLAUDE_CONCLUSION: ${{ steps.claude.conclusion }}
          INPUT_MODEL: ${{ inputs.model }}
          INPUT_TIMEOUT_MINUTES: ${{ inputs.timeout_minutes }}
          INPUT_PROMPT: ${{ inputs.prompt }}
          INPUT_ALLOWED_TOOLS: ${{ inputs.allowed_tools }}
          INPUT_DISALLOWED_TOOLS: ${{ inputs.disallowed_tools }}
          INPUT_MAX_TURNS: ${{ inputs.max_turns }}
          EVENT_NAME: ${{ github.event_name }}
          REPOSITORY: ${{ github.repository }}
        with:
          script: |
            // Build summary
            let summary = '# ü§ñ Claude Code Execution Summary\n\n';

            // Add status
            const conclusion = process.env.CLAUDE_CONCLUSION;
            if (conclusion === 'success') {
              summary += '‚úÖ **Status:** Completed successfully\n\n';
            } else if (conclusion === 'failure') {
              summary += '‚ùå **Status:** Failed\n\n';
            } else if (conclusion === 'cancelled') {
              summary += '‚è∏Ô∏è **Status:** Cancelled\n\n';
            } else {
              summary += '‚ö†Ô∏è **Status:** Unknown\n\n';
            }

            // Add configuration
            summary += '**Configuration:**\n';
            summary += `- Model: \`${process.env.INPUT_MODEL}\`\n`;
            summary += `- Timeout: ${process.env.INPUT_TIMEOUT_MINUTES} minutes\n`;

            if (process.env.INPUT_PROMPT) {
              summary += '- Mode: Automation (direct prompt)\n';
            } else {
              summary += '- Mode: Interactive (@claude mentions)\n';
            }

            if (process.env.INPUT_ALLOWED_TOOLS) {
              summary += `- Allowed Tools: \`${process.env.INPUT_ALLOWED_TOOLS}\`\n`;
            } else {
              summary += '- Tools: Default (permissive)\n';
            }

            if (process.env.INPUT_DISALLOWED_TOOLS) {
              summary += `- Disallowed Tools: \`${process.env.INPUT_DISALLOWED_TOOLS}\`\n`;
            }

            if (process.env.INPUT_MAX_TURNS) {
              summary += `- Max Turns: ${process.env.INPUT_MAX_TURNS}\n`;
            }

            // Add context
            summary += '\n**Context:**\n';
            summary += `- Event: \`${process.env.EVENT_NAME}\`\n`;
            summary += `- Repository: \`${process.env.REPOSITORY}\`\n`;
            if (context.issue.number) {
              summary += `- Issue/PR: #${context.issue.number}\n`;
            }

            // Write summary
            await core.summary.addRaw(summary).write();
