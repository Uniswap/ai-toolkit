# Reusable workflow for preparing Linear tasks for Claude Code processing
#
# This workflow queries Linear for issues matching specified criteria and outputs
# a matrix for parallel processing. It's designed to be called by orchestrating
# workflows that need to fan out to multiple Claude task workers.
#
# MULTI-TEAM SUPPORT:
# This workflow supports querying issues from multiple Linear teams. Use the
# `linear_teams` input with a comma-separated list of team names, or use
# `linear_team` for a single team (backwards compatible).
#
# USAGE:
# Call this workflow from a parent workflow:
#
# jobs:
#   prepare:
#     uses: ./.github/workflows/_claude-task-prepare.yml
#     with:
#       # Single team (backwards compatible):
#       linear_team: "Developer AI"
#       # OR multiple teams:
#       linear_teams: "Developer AI,Apps Infra,Backend Engineering"
#       linear_label: "claude"
#       max_issues: "3"
#     secrets:
#       LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
#
#   process-task:
#     needs: prepare
#     if: needs.prepare.outputs.has_tasks == 'true'
#     strategy:
#       matrix: ${{ fromJson(needs.prepare.outputs.matrix_json) }}
#     uses: ./.github/workflows/_claude-task-worker.yml
#     with:
#       issue_id: ${{ matrix.issue_id }}
#       issue_identifier: ${{ matrix.issue_identifier }}
#       linear_team: ${{ matrix.linear_team }}
#       # ... other inputs
#
# OUTPUTS:
# - matrix_json: GitHub Actions matrix JSON (contains 'include' array)
# - has_tasks: 'true' if tasks found, 'false' otherwise
# - result: Full query result JSON for summary/debugging
# - linear_task_utils_tag: Resolved tag for passing to worker
#
# SECRETS REQUIRED:
# - LINEAR_API_KEY: Linear API key for querying issues

name: "[claude] Task Prepare"

on:
  workflow_call:
    inputs:
      linear_teams:
        description: |
          Comma-separated list of Linear team names to query.
          Example: "Developer AI,Apps Infra,Backend Engineering"
          Takes precedence over linear_team if both are provided.
        required: false
        type: string

      linear_team:
        description: |
          Single Linear team name to query (backwards compatible).
          Use linear_teams for multi-team support.
          Ignored if linear_teams is provided.
        required: false
        type: string

      linear_label:
        description: "Label to filter issues by"
        required: true
        type: string

      max_issues:
        description: "Maximum number of issues to process"
        required: false
        type: string
        default: "3"

      linear_task_utils_tag:
        description: "npm tag for @uniswap/ai-toolkit-linear-task-utils (latest or next)"
        required: false
        type: string
        default: "next"

      target_branch:
        description: "Branch to checkout (issues are queried from this branch's state)"
        required: false
        type: string
        default: "next"

    outputs:
      matrix_json:
        description: "Matrix JSON for GitHub Actions strategy (contains 'include' array)"
        value: ${{ jobs.prepare.outputs.matrix_json }}

      has_tasks:
        description: "Whether any tasks were found ('true' or 'false')"
        value: ${{ jobs.prepare.outputs.has_tasks }}

      result:
        description: "Full query result JSON for summary/debugging"
        value: ${{ jobs.prepare.outputs.result }}

      linear_task_utils_tag:
        description: "The resolved linear_task_utils_tag (for passing to worker)"
        value: ${{ jobs.prepare.outputs.linear_task_utils_tag }}

    secrets:
      LINEAR_API_KEY:
        description: "Linear API key for querying issues"
        required: true

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix_json: ${{ steps.query.outputs.matrix_json }}
      result: ${{ steps.query.outputs.result }}
      has_tasks: ${{ steps.query.outputs.has_tasks }}
      linear_task_utils_tag: ${{ inputs.linear_task_utils_tag }}

    steps:
      # Security scanning
      - name: Security scanning
        uses: bullfrogsec/bullfrog@1831f79cce8ad602eef14d2163873f27081ebfb3 # v0.8.4
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          ref: ${{ inputs.target_branch }}

      - name: Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: "22.21.1"

      # Determine the list of teams to query
      # Supports both linear_teams (comma-separated) and linear_team (single, backwards compatible)
      - name: Determine teams
        id: teams
        env:
          INPUT_LINEAR_TEAMS: ${{ inputs.linear_teams }}
          INPUT_LINEAR_TEAM: ${{ inputs.linear_team }}
        run: |
          # Use linear_teams if provided, otherwise fall back to linear_team
          if [ -n "$INPUT_LINEAR_TEAMS" ]; then
            TEAMS_LIST="$INPUT_LINEAR_TEAMS"
            echo "Using multi-team input: $TEAMS_LIST"
          elif [ -n "$INPUT_LINEAR_TEAM" ]; then
            TEAMS_LIST="$INPUT_LINEAR_TEAM"
            echo "Using single team input (backwards compatible): $TEAMS_LIST"
          else
            echo "::error::Either linear_teams or linear_team must be provided"
            exit 1
          fi
          echo "teams=$TEAMS_LIST" >> $GITHUB_OUTPUT

      # Ensure the claude label exists in all teams
      - name: Ensure label exists in all teams
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
          LINEAR_TASK_UTILS_TAG: ${{ inputs.linear_task_utils_tag }}
          TEAMS_LIST: ${{ steps.teams.outputs.teams }}
          LINEAR_LABEL: ${{ inputs.linear_label }}
        run: |
          # Convert comma-separated list to array and iterate
          IFS=',' read -ra TEAMS <<< "$TEAMS_LIST"
          for TEAM in "${TEAMS[@]}"; do
            # Trim whitespace
            TEAM=$(echo "$TEAM" | xargs)
            echo "Ensuring label '$LINEAR_LABEL' exists in team '$TEAM'..."
            npx "@uniswap/ai-toolkit-linear-task-utils@${LINEAR_TASK_UTILS_TAG}" ensure-label \
              --team "$TEAM" \
              --label "$LINEAR_LABEL"
          done

      # Query Linear for issues from all teams
      - name: Query Linear issues from all teams
        id: query
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
          LINEAR_TASK_UTILS_TAG: ${{ inputs.linear_task_utils_tag }}
          TEAMS_LIST: ${{ steps.teams.outputs.teams }}
          LINEAR_LABEL: ${{ inputs.linear_label }}
          MAX_ISSUES: ${{ inputs.max_issues }}
        run: |
          # Initialize empty combined results
          COMBINED_INCLUDE='[]'
          TOTAL_COUNT=0

          # Convert comma-separated list to array and iterate
          IFS=',' read -ra TEAMS <<< "$TEAMS_LIST"
          for TEAM in "${TEAMS[@]}"; do
            # Trim whitespace
            TEAM=$(echo "$TEAM" | xargs)
            echo "Querying issues from team '$TEAM'..."

            RESULT=$(npx "@uniswap/ai-toolkit-linear-task-utils@${LINEAR_TASK_UTILS_TAG}" query \
              --team "$TEAM" \
              --label "$LINEAR_LABEL" \
              --statuses "Backlog,Todo" \
              --max "$MAX_ISSUES")

            # Extract count and issues from this team
            TEAM_COUNT=$(echo "$RESULT" | jq -r '.count')
            TEAM_ISSUES=$(echo "$RESULT" | jq -c '.include')

            echo "Found $TEAM_COUNT issue(s) in team '$TEAM'"

            # Merge issues into combined array
            COMBINED_INCLUDE=$(echo "$COMBINED_INCLUDE" "$TEAM_ISSUES" | jq -sc '.[0] + .[1]')
            TOTAL_COUNT=$((TOTAL_COUNT + TEAM_COUNT))
          done

          # Sort combined results by priority (1=Urgent, 2=High, 3=Normal, 4=Low, 0=No Priority)
          # Priority sort order: 1, 2, 3, 4, 0 (Urgent first, No Priority last)
          SORTED_INCLUDE=$(echo "$COMBINED_INCLUDE" | jq -c '
            sort_by(
              if .priority == 1 then 0
              elif .priority == 2 then 1
              elif .priority == 3 then 2
              elif .priority == 4 then 3
              else 4
              end
            )
          ')

          # Limit to max_issues total across all teams
          LIMITED_INCLUDE=$(echo "$SORTED_INCLUDE" | jq -c ".[0:${MAX_ISSUES}]")
          LIMITED_COUNT=$(echo "$LIMITED_INCLUDE" | jq 'length')

          # Build final result
          FINAL_RESULT=$(jq -nc --argjson include "$LIMITED_INCLUDE" --arg count "$LIMITED_COUNT" \
            '{include: $include, count: ($count | tonumber)}')

          # Store full result for summary step
          echo "result=$FINAL_RESULT" >> $GITHUB_OUTPUT

          # Extract only the 'include' array for the matrix strategy
          # GitHub Actions matrix only accepts array values, not scalar properties like 'count'
          MATRIX_JSON=$(echo "$FINAL_RESULT" | jq -c '{include: .include}')
          echo "matrix_json=$MATRIX_JSON" >> $GITHUB_OUTPUT

          # Check if we have tasks
          if [ "$LIMITED_COUNT" -gt 0 ]; then
            echo "has_tasks=true" >> $GITHUB_OUTPUT
            echo "Found $LIMITED_COUNT issue(s) to process (from $TOTAL_COUNT total across all teams)"
          else
            echo "has_tasks=false" >> $GITHUB_OUTPUT
            echo "No issues found matching criteria across any team"
          fi

      # Create summary for prepare job
      - name: Create prepare summary
        env:
          QUERY_RESULT: ${{ steps.query.outputs.result }}
          INPUT_LINEAR_TEAMS: ${{ steps.teams.outputs.teams }}
          INPUT_LINEAR_LABEL: ${{ inputs.linear_label }}
          INPUT_MAX_ISSUES: ${{ inputs.max_issues }}
          INPUT_TARGET_BRANCH: ${{ inputs.target_branch }}
          INPUT_LINEAR_TASK_UTILS_TAG: ${{ inputs.linear_task_utils_tag }}
        run: |
          echo "## Prepare Phase" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Configuration:**" >> $GITHUB_STEP_SUMMARY
          echo "- Teams: $INPUT_LINEAR_TEAMS" >> $GITHUB_STEP_SUMMARY
          echo "- Label: $INPUT_LINEAR_LABEL" >> $GITHUB_STEP_SUMMARY
          echo "- Max Issues: $INPUT_MAX_ISSUES" >> $GITHUB_STEP_SUMMARY
          echo "- Target Branch: $INPUT_TARGET_BRANCH" >> $GITHUB_STEP_SUMMARY
          echo "- Linear Task Utils Tag: $INPUT_LINEAR_TASK_UTILS_TAG" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          COUNT=$(echo "$QUERY_RESULT" | jq -r '.count')
          echo "**Issues Found:** $COUNT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$COUNT" -gt 0 ]; then
            echo "| Identifier | Team | Title | Priority |" >> $GITHUB_STEP_SUMMARY
            echo "|------------|------|-------|----------|" >> $GITHUB_STEP_SUMMARY
            echo "$QUERY_RESULT" | jq -r '.include[] | "| \(.issue_identifier) | \(.linear_team) | \(.issue_title) | \(.priority_label) |"' >> $GITHUB_STEP_SUMMARY
          fi
