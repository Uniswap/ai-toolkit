name: Generate Changelog

# Reusable workflow for generating AI-powered changelogs from git commit ranges.
# This workflow can be called by other workflows to generate consistent, high-quality
# changelogs using Anthropic's Claude API.

on:
  workflow_call:
    inputs:
      before_sha:
        description: 'Starting commit SHA for the changelog range'
        required: true
        type: string
      after_sha:
        description: 'Ending commit SHA for the changelog range'
        required: true
        type: string
      custom_prompt_file:
        description: 'Path to custom prompt markdown file (relative to repo root, e.g., .github/prompts/my-prompt.md)'
        required: false
        type: string
      custom_prompt_text:
        description: 'Inline custom prompt text (overrides custom_prompt_file if both provided)'
        required: false
        type: string
      max_tokens:
        description: 'Maximum tokens for AI response'
        required: false
        type: number
        default: 1024
    outputs:
      changelog:
        description: 'Generated changelog text'
        value: ${{ jobs.generate.outputs.changelog }}
      generation_method:
        description: 'Method used to generate changelog (ai or fallback)'
        value: ${{ jobs.generate.outputs.method }}
    secrets:
      ANTHROPIC_API_KEY:
        description: 'Anthropic API key for AI changelog generation'
        required: true

jobs:
  generate:
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    outputs:
      changelog: ${{ steps.ai-changelog.outputs.changelog || steps.fallback-changelog.outputs.changelog }}
      method: ${{ steps.ai-changelog.outcome == 'success' && 'ai' || 'fallback' }}

    steps:
      - uses: bullfrogsec/bullfrog@1831f79cce8ad602eef14d2163873f27081ebfb3 # v0.8.4

      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0

      - name: Get git diff and commit messages
        id: git-context
        run: |
          BEFORE_SHA="${{ inputs.before_sha }}"
          AFTER_SHA="${{ inputs.after_sha }}"

          echo "Comparing commits: $BEFORE_SHA...$AFTER_SHA"

          # Get the diff with file changes and commit messages
          DIFF_OUTPUT=$(git diff --stat "$BEFORE_SHA...$AFTER_SHA")
          COMMIT_MESSAGES=$(git log --pretty=format:"- %s (%h)" "$BEFORE_SHA..$AFTER_SHA")

          # Combine into a single context for the AI
          FULL_CONTEXT="## Commits in this range:
          $COMMIT_MESSAGES

          ## Files changed:
          $DIFF_OUTPUT"

          # Save to output using heredoc
          {
            echo 'context<<EOF'
            echo "$FULL_CONTEXT"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: Load custom prompt from file
        id: load-prompt
        if: inputs.custom_prompt_file != ''
        run: |
          PROMPT_FILE="${{ inputs.custom_prompt_file }}"

          if [ ! -f "$PROMPT_FILE" ]; then
            echo "Error: Custom prompt file not found: $PROMPT_FILE"
            exit 1
          fi

          # Read the prompt file
          CUSTOM_PROMPT=$(cat "$PROMPT_FILE")

          # Save to output using heredoc
          {
            echo 'prompt<<EOF'
            echo "$CUSTOM_PROMPT"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

          echo "‚úÖ Loaded custom prompt from $PROMPT_FILE"

      - name: Generate AI-powered changelog
        id: ai-changelog
        continue-on-error: true
        run: |
          # Determine which prompt to use (priority: inline > file > default)
          if [ -n "${{ inputs.custom_prompt_text }}" ]; then
            PROMPT="${{ inputs.custom_prompt_text }}"
            echo "Using inline custom prompt"
          elif [ -n "${{ steps.load-prompt.outputs.prompt }}" ]; then
            PROMPT="${{ steps.load-prompt.outputs.prompt }}"
            echo "Using custom prompt from file"
          else
            # Default prompt (similar to notify-release.yml)
            PROMPT="You are a changelog generator. Based on the following git changes, create a concise, human-readable changelog summary.

          Focus on:
          - What features were added
          - What bugs were fixed
          - What was changed or improved

          Format requirements:
          - Use bullet points (‚Ä¢ or -) for each item
          - Keep it to 3-10 items max
          - Be concise and clear
          - Do NOT include commit hashes unless specifically requested
          - Group related changes together"
            echo "Using default prompt"
          fi

          # Append the git context to the prompt
          FULL_PROMPT="$PROMPT

          ${{ steps.git-context.outputs.context }}"

          # Call Anthropic API
          RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: ${{ secrets.ANTHROPIC_API_KEY }}" \
            -H "anthropic-version: 2023-06-01" \
            -d @- <<EOF
          {
            "model": "claude-haiku-4-5",
            "max_tokens": ${{ inputs.max_tokens }},
            "messages": [{
              "role": "user",
              "content": $(echo "$FULL_PROMPT" | jq -Rs .)
            }]
          }
          EOF
          )

          # Extract the changelog from the response
          CHANGELOG=$(echo "$RESPONSE" | jq -r '.content[0].text // empty')

          if [ -z "$CHANGELOG" ]; then
            echo "Error: Failed to generate changelog from API response"
            echo "Response: $RESPONSE"
            exit 1
          fi

          echo "‚úÖ AI changelog generated successfully"

          # Save to output
          {
            echo 'changelog<<EOF'
            echo "$CHANGELOG"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: Generate fallback changelog from commits
        if: steps.ai-changelog.outcome == 'failure'
        id: fallback-changelog
        run: |
          BEFORE_SHA="${{ inputs.before_sha }}"
          AFTER_SHA="${{ inputs.after_sha }}"

          echo "‚ö†Ô∏è AI generation failed, using fallback changelog"

          # Get commits between the two SHAs
          COMMITS=$(git log --pretty=format:"‚Ä¢ %s (%h)" "$BEFORE_SHA..$AFTER_SHA" | head -n 20)

          if [ -z "$COMMITS" ]; then
            COMMITS="‚Ä¢ No commits found in this range"
          fi

          # Save to output
          {
            echo 'changelog<<EOF'
            echo "$COMMITS"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: Summary
        if: always()
        run: |
          echo "## üìù Changelog Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit Range**: \`${{ inputs.before_sha }}\` ‚Üí \`${{ inputs.after_sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Generation Method**: ${{ steps.ai-changelog.outcome == 'success' && 'AI-powered ‚ú®' || 'Fallback (commit list) ‚ö†Ô∏è' }}" >> $GITHUB_STEP_SUMMARY

          if [ -n "${{ inputs.custom_prompt_text }}" ]; then
            echo "- **Prompt Source**: Inline custom prompt" >> $GITHUB_STEP_SUMMARY
          elif [ -n "${{ inputs.custom_prompt_file }}" ]; then
            echo "- **Prompt Source**: \`${{ inputs.custom_prompt_file }}\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Prompt Source**: Default prompt" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Generated Changelog:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.ai-changelog.outputs.changelog || steps.fallback-changelog.outputs.changelog }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
