# Lefthook configuration for AI Toolkit
# https://github.com/evilmartians/lefthook

pre-commit:
  parallel: false # Changed to false to ensure format runs before lint
  commands:
    format:
      run: |
        # Get list of staged files before formatting
        STAGED_FILES=$(git diff --cached --name-only)
        # Run formatter on affected files (redirect its output to stderr to see it but not interfere)
        bunx nx format:write --affected --base=HEAD~1 2>&1
        # Re-stage only the files that were already staged (and still exist)
        if [ -n "$STAGED_FILES" ]; then
          for file in $STAGED_FILES; do
            if [ -f "$file" ]; then
              git add "$file"
            fi
          done
        fi
      tags: format
      skip:
        - merge
        - rebase
      fail_text: 'Formatting failed. Please review the changes.'

    lint:
      run: bunx nx affected --target=lint --base=HEAD~1 --fix
      tags: lint
      skip:
        - merge
        - rebase
      fail_text: 'Linting failed. Please fix the issues before committing.'
    typecheck:
      run: bunx nx affected --target=typecheck --base=HEAD~1
      tags: typecheck
      skip:
        - merge
        - rebase
      fail_text: 'Typechecking failed. Please fix the issues before committing.'

# Skip hooks if in CI or if LEFTHOOK=0 is set
skip_output:
  - meta
  - success
